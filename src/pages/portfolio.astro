---
import Layout from '../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const { data: latestSnapshot } = await supabase
  .from('portfolio_snapshots')
  .select('*')
  .order('timestamp', { ascending: false })
  .limit(1)
  .single();

const positions = latestSnapshot?.raw_positions || [];
const sectors = latestSnapshot?.sector_performance || [];
---

<Layout title="Portfolio - The Dystopia Fund">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-white mb-6">Current Holdings</h1>

    {latestSnapshot ? (
      <>
        <div class="bg-gray-900 rounded-lg p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <div class="text-gray-400 text-xs mb-1">Total Value</div>
            <div class="text-xl font-bold text-white">${parseFloat(latestSnapshot.total_value).toLocaleString()}</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Daily P&L</div>
            <div class={`text-xl font-bold ${parseFloat(latestSnapshot.daily_pl) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
              ${parseFloat(latestSnapshot.daily_pl) >= 0 ? '+' : ''}{parseFloat(latestSnapshot.daily_pl).toLocaleString()}
            </div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Cash</div>
            <div class="text-xl font-bold text-white">${parseFloat(latestSnapshot.cash).toLocaleString()}</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Positions</div>
            <div class="text-xl font-bold text-white">{latestSnapshot.position_count}</div>
          </div>
        </div>

        <div class="bg-gray-900 rounded-lg p-4 mb-6">
          <h2 class="text-white text-lg font-bold mb-3">Sector Performance</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {sectors.map(sector => (
              <div class="bg-gray-800 rounded p-3">
                <div class="text-gray-400 text-xs mb-1">{sector.sector}</div>
                <div class={`text-lg font-bold ${parseFloat(sector.totalPL) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                  ${parseFloat(sector.totalPL) >= 0 ? '+' : ''}{parseFloat(sector.totalPL).toLocaleString()}
                </div>
                <div class="text-gray-500 text-xs">{sector.stockCount} stocks</div>
              </div>
            ))}
          </div>
        </div>

        <div class="bg-gray-900 rounded-lg p-4">
          <h2 class="text-white text-lg font-bold mb-3">All Positions</h2>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-400 border-b border-gray-800">
                  <th class="text-left py-2">Symbol</th>
                  <th class="text-right py-2">Qty</th>
                  <th class="text-right py-2">Value</th>
                  <th class="text-right py-2">P&L</th>
                  <th class="text-right py-2">%</th>
                </tr>
              </thead>
              <tbody>
                {positions.map(position => (
                  <tr class="border-b border-gray-800 hover:bg-gray-800">
                    <td class="py-2 font-mono font-bold text-white">{position.symbol}</td>
                    <td class="text-right text-gray-400">{position.qty}</td>
                    <td class="text-right text-white">${parseFloat(position.value).toLocaleString()}</td>
                    <td class={`text-right font-bold ${parseFloat(position.pl) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                      ${parseFloat(position.pl) >= 0 ? '+' : ''}{parseFloat(position.pl).toLocaleString()}
                    </td>
                    <td class={`text-right font-bold ${parseFloat(position.plPercent) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                      {parseFloat(position.plPercent) >= 0 ? '+' : ''}{position.plPercent}%
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </>
    ) : (
      <div class="bg-gray-900 rounded-lg p-8 text-center">
        <p class="text-gray-400">Loading portfolio data...</p>
      </div>
    )}
  </div>
</Layout>
