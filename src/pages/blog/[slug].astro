---
import Layout from '../../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// This function tells Astro which pages to generate at build time
export async function getStaticPaths() {
  const { data: posts } = await supabase
    .from('blog_posts')
    .select('slug')
    .eq('is_published', true);

  return posts?.map(post => ({
    params: { slug: post.slug }
  })) || [];
}

const { slug } = Astro.params;

const { data: post } = await supabase
  .from('blog_posts')
  .select('*')
  .eq('slug', slug)
  .eq('is_published', true)
  .single();

if (!post) {
  return Astro.redirect('/404');
}
---

<Layout title={`${post.title} - The Dystopia Fund`}>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <header class="mb-8">
      <h1 class="text-4xl font-bold text-white mb-4">{post.title}</h1>
      <div class="flex items-center gap-4 text-gray-400 text-sm">
        <span>{post.author}</span>
        <span>•</span>
        <time datetime={post.published_at}>
          {new Date(post.published_at).toLocaleDateString('en-US', { 
            month: 'long', 
            day: 'numeric', 
            year: 'numeric' 
          })}
        </time>
      </div>
    </header>

    <div class="prose prose-invert prose-lg max-w-none">
      <div class="text-gray-300 leading-relaxed whitespace-pre-wrap">
        {post.content}
      </div>
    </div>

    <footer class="mt-12 pt-8 border-t border-gray-800">
      <a href="/" class="text-blue-400 hover:text-blue-300">← Back to Home</a>
    </footer>
  </article>
</Layout>
