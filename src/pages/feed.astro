---
import Layout from '../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const { data: latestSnapshot } = await supabase
  .from('portfolio_snapshots')
  .select('*')
  .order('timestamp', { ascending: false })
  .limit(1)
  .single();

const { data: rawNews } = await supabase
  .from('news_articles')
  .select('id, title, description, url, topic, score, published_at')
  .order('published_at', { ascending: false })
  .limit(100); // grab a bit more, we’ll slice later

const seen = new Set();
const newsArticles = (rawNews || [])
  .filter(article => {
    if (!article.url) return false;
    if (seen.has(article.url)) return false;
    seen.add(article.url);
    return true;
  })
  .slice(0, 50);

const stats = latestSnapshot ? {
  dailyPL: parseFloat(latestSnapshot.daily_pl || 0),
  dailyPLPercent: parseFloat(latestSnapshot.daily_pl_percent || 0),
  totalValue: parseFloat(latestSnapshot.total_value || 0),
  topGainer: latestSnapshot.top_gainers?.[0],
  topLoser: latestSnapshot.top_losers?.[0]
} : null;

const { data: taglines, error } = await supabase
  .from('dystopia_taglines')
  .select('text')
  .eq('active', true)
  .order('created_at', { ascending: false })
  .limit(20);

// Normalize to an array of strings
const taglineList = (taglines ?? [])
  .map((row) => (typeof row === 'string' ? row : row.text))
  .filter(Boolean);

const fallback =
  "No optimization, no engagement loops, just the slow leak of reality.";

const tagline =
  taglineList.length > 0
    ? taglineList[Math.floor(Math.random() * taglineList.length)]
    : fallback;
---

<Layout title="The Dystopia Fund">
  <div class="max-w-6xl mx-auto px-4 py-6">
    {stats && (
      <div class="bg-gray-900 rounded-lg p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div>
          <div class="text-gray-400 text-xs mb-1">24H P&L</div>
          <div class=`text-lg font-bold ${stats.dailyPL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
            ${stats.dailyPL >= 0 ? '+' : ''}{stats.dailyPL.toFixed(2)}
            <span class="text-sm ml-1">({stats.dailyPLPercent >= 0 ? '+' : ''}{stats.dailyPLPercent}%)</span>
          </div>
        </div>
        <div>
          <div class="text-gray-400 text-xs mb-1">Portfolio Value</div>
          <div class="text-lg font-bold text-white">${stats.totalValue.toFixed(2)}</div>
        </div>
        {stats.topGainer && (
          <div>
            <div class="text-gray-400 text-xs mb-1">Top Gainer</div>
            <div class="text-lg font-bold text-green-400">{stats.topGainer.symbol} <span class="text-sm">+{stats.topGainer.plPercent}%</span></div>
          </div>
        )}
        {stats.topLoser && (
          <div>
            <div class="text-gray-400 text-xs mb-1">Top Loser</div>
            <div class="text-lg font-bold text-red-400">{stats.topLoser.symbol} <span class="text-sm">{stats.topLoser.plPercent}%</span></div>
          </div>
        )}
      </div>
    )}
    
    <div class="mt-8">
      <h2 class="text-white text-2xl font-bold mb-4">Curated News Free from the Algorithm</h2>
      <p class="text-gray-500 text-sm italic mb-6 leading-relaxed">{tagline}</p>
 <div class="space-y-3">
        {newsArticles?.map(article => (
          <a href={article.url} target="_blank" rel="noopener" class="block bg-gray-900 rounded-lg p-3 hover:bg-gray-800 transition-colors">
            <h3 class="text-white text-sm font-semibold mb-1 leading-tight">{article.title}</h3>

            <div class="flex items-center justify-between text-gray-500 text-xs">
              <div class="flex items-center space-x-3">
                <span>{article.published_at}</span>
                <span class="text-gray-600">•</span>
                <span class="text-blue-400">{article.topic}</span>
              </div>
              <span class="text-orange-400 font-mono">Score: {parseFloat(article.score).toFixed(1)}</span>
            </div>
          </a>
        ))}
      </div>
    </div>
  </div>
</Layout>