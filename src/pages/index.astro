---
import Layout from '../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const chartUrl = "https://uyakfgtlltexwhzlceai.supabase.co/storage/v1/object/public/charts/daily.png";

const alt = "Dark line chart of Dystopia Fund daily percent returns over the last 90 days with a bold 7-day rolling average line.";

const { data: latestSnapshot } = await supabase
  .from('portfolio_snapshots')
  .select('*')
  .order('timestamp', { ascending: false })
  .limit(1)
  .single();

const { data: blogPosts } = await supabase
  .from('blog_posts')
  .select('id, title, slug, excerpt, published_at')
  .eq('is_published', true)
  .order('published_at', { ascending: false })
  .limit(3);

const { data: newsEditor } = await supabase
  .from('news_editor')
  .select('id, title, slug, published_at')
  .eq('is_published', true)
  .order('published_at', { ascending: false })
  .limit(3);


const { data: newsArticles } = await supabase
  .from('news_articles_dystopia')
  .select('*')
  .order('published_at', { ascending: false })
  .limit(20);

const stats = latestSnapshot ? {
  dailyPL: parseFloat(latestSnapshot.daily_pl || 0),
  dailyPLPercent: parseFloat(latestSnapshot.daily_pl_percent || 0),
  totalValue: parseFloat(latestSnapshot.total_value || 0),
  topGainer: latestSnapshot.top_gainers?.[0],
  topLoser: latestSnapshot.top_losers?.[0]
} : null;
---

<Layout title="The Dystopia Fund">
  <div class="max-w-6xl mx-auto px-4 py-6">
    {stats && (
      <div class="bg-gray-900 rounded-lg p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div>
          <div class="text-gray-400 text-xs mb-1">24H P&L</div>
          <div class=`text-lg font-bold ${stats.dailyPL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
            ${stats.dailyPL >= 0 ? '+' : ''}{stats.dailyPL.toFixed(2)}
            <span class="text-sm ml-1">({stats.dailyPLPercent >= 0 ? '+' : ''}{stats.dailyPLPercent}%)</span>
          </div>
        </div>
        <div>
          <div class="text-gray-400 text-xs mb-1">Portfolio Value</div>
          <div class="text-lg font-bold text-white">${stats.totalValue.toFixed(2)}</div>
        </div>
        {stats.topGainer && (
          <div>
            <div class="text-gray-400 text-xs mb-1">Top Gainer</div>
            <div class="text-lg font-bold text-green-400">{stats.topGainer.symbol} <span class="text-sm">+{stats.topGainer.plPercent}%</span></div>
          </div>
        )}
        {stats.topLoser && (
          <div>
            <div class="text-gray-400 text-xs mb-1">Top Loser</div>
            <div class="text-lg font-bold text-red-400">{stats.topLoser.symbol} <span class="text-sm">{stats.topLoser.plPercent}%</span></div>
          </div>
        )}
      </div>
    )}
    
    <div>
      <img src={chartUrl} alt={alt} width="1200" height="600" loading="lazy" />
    </div>

    <div>
      <h2 class="text-white text-2xl font-bold mb-4">Observations</h2>
      <div class="space-y-4">
        {newsEditor?.map(post => (
          <a href=`/news/${post.slug}`} class="block bg-gray-900 rounded-lg p-4 hover:bg-gray-800 transition-colors">
            <h3 class="text-white text-lg font-bold mb-2">{post.title}</h3>
            <p class="text-gray-400 text-sm mb-2">{post.slug}</p>
            <div class="text-gray-500 text-xs">{new Date(post.published_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
          </a>
        ))}
      </div>
    </div>

    <div>
      <h2 class="text-white text-2xl font-bold mb-4"></h2>
      <h2 class="text-white text-2xl font-bold mb-4">Blog Posts</h2>
      <div class="space-y-4">
        {blogPosts?.map(post => (
          <a href=`/blog/${post.slug}`} class="block bg-gray-900 rounded-lg p-4 hover:bg-gray-800 transition-colors">
            <h3 class="text-white text-lg font-bold mb-2">{post.title}</h3>
            <p class="text-gray-400 text-sm mb-2">{post.excerpt}</p>
            <div class="text-gray-500 text-xs">{new Date(post.published_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
          </a>
        ))}
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-white text-2xl font-bold mb-4">Dystopian News Feed</h2>
      <div class="space-y-3">
        {newsArticles?.map(article => (
          <a href={article.url} target="_blank" rel="noopener" class="block bg-gray-900 rounded-lg p-3 hover:bg-gray-800 transition-colors">
            <h3 class="text-white text-sm font-semibold mb-1 leading-tight">{article.title}</h3>
            <div class="flex items-center justify-between text-gray-500 text-xs">
              <div class="flex items-center space-x-3">
                <span>{article.source}</span>
                <span class="text-gray-600">â€¢</span>
                <span class="text-blue-400">{article.search_query}</span>
              </div>
              <span class="text-orange-400 font-mono">Score: {parseFloat(article.dystopia_score).toFixed(1)}</span>
            </div>
          </a>
        ))}
      </div>
    </div>
  </div>
</Layout>