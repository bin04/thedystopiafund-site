---
import Layout from '../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const { data: contracts } = await supabase
  .from('government_contracts')
  .select('*')
  .order('posted_date', { ascending: false })
  .limit(50);

const contractsWithTickers = contracts?.filter(c => c.matched_ticker) || [];
const totalValue = contracts?.reduce((sum, c) => sum + (parseFloat(c.award_amount) || 0), 0) || 0;
const avgDystopiaScore = contracts?.length ? contracts.reduce((sum, c) => sum + c.dystopia_score, 0) / contracts.length : 0;
---

<Layout title="Government Contracts - The Dystopia Fund">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-white mb-6">Government Contracts</h1>

    <div class="bg-gray-900 rounded-lg p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
      <div>
        <div class="text-gray-400 text-xs mb-1">Total Contracts</div>
        <div class="text-xl font-bold text-white">{contracts?.length || 0}</div>
      </div>
      <div>
        <div class="text-gray-400 text-xs mb-1">Total Value</div>
        <div class="text-xl font-bold text-white">${(totalValue / 1000000).toFixed(1)}M</div>
      </div>
      <div>
        <div class="text-gray-400 text-xs mb-1">Avg Dystopia Score</div>
        <div class="text-xl font-bold text-red-400">{avgDystopiaScore.toFixed(1)}</div>
      </div>
      {contractsWithTickers.length > 0 && (
        <div>
          <div class="text-gray-400 text-xs mb-1">Public Companies</div>
          <div class="text-xl font-bold text-white">{contractsWithTickers.length}</div>
        </div>
      )}
    </div>

    <div class="space-y-3">
      {contracts?.map(contract => (
        <div class="bg-gray-900 rounded-lg p-4 hover:bg-gray-800 transition-colors">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1">
              <h3 class="text-white font-bold mb-1">{contract.title}</h3>
              <p class="text-gray-400 text-sm mb-2">{contract.department}</p>
            </div>
            <div class="text-right ml-4">
              <div class="text-white font-bold">${(parseFloat(contract.award_amount) / 1000000).toFixed(2)}M</div>
              {contract.matched_ticker && (
                <div class="text-green-400 text-sm font-mono">{contract.matched_ticker}</div>
              )}
            </div>
          </div>
          <div class="flex items-center gap-3 text-xs">
            <span class="text-gray-500">{contract.awardee}</span>
            <span class="text-gray-600">•</span>
            <span class="text-red-400">Dystopia Score: {contract.dystopia_score}</span>
            <span class="text-gray-600">•</span>
            <span class="text-gray-500">{new Date(contract.posted_date).toLocaleDateString()}</span>
            <a href={contract.url} target="_blank" class="text-blue-400 hover:text-blue-300 ml-auto">View →</a>
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>
