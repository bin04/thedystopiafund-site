---
import Layout from '../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// Latest snapshot (stats)
const { data: latestSnapshot } = await supabase
  .from('portfolio_snapshots')
  .select('*')
  .order('timestamp', { ascending: false })
  .limit(1)
  .single();

// Observations posts
const { data: blogPosts } = await supabase
  .from('news_editor')
  .select('id, title, slug, excerpt, published_at')
  .eq('is_published', true)
  .order('published_at', { ascending: false })
  .limit(1);

// Fake news, last 8 hours
const eightHoursAgo = new Date(Date.now() - 8 * 60 * 60 * 1000).toISOString();

const { data: newsArticles, error } = await supabase
  .from('fake_news')
  .select('*')
  .gte('created_at', eightHoursAgo)
  .order('source', { ascending: true })         // group sort
  .order('published_at', { ascending: false })  // newest first within group
  .limit(400);

// Group by source
const groups = (newsArticles ?? []).reduce((acc, article) => {
  const key = article.source || 'Unknown';
  (acc[key] ||= []).push(article);
  return acc;
}, {});

// Sort sources alphabetically, "Unknown" at the end
const sortedSources = Object.keys(groups).sort((a, b) => {
  if (a === 'Unknown') return 1;
  if (b === 'Unknown') return -1;
  return a.localeCompare(b);
});

const stats = latestSnapshot ? {
  dailyPL: parseFloat(latestSnapshot.daily_pl || 0),
  dailyPLPercent: parseFloat(latestSnapshot.daily_pl_percent || 0),
  totalValue: parseFloat(latestSnapshot.total_value || 0),
  topGainer: latestSnapshot.top_gainers?.[0],
  topLoser: latestSnapshot.top_losers?.[0]
} : null;

// helpers
const fmtScore = (v) => {
  const n = parseFloat(v);
  return Number.isFinite(n) ? n.toFixed(1) : '—';
};
---
<Layout title="The Dystopia Fund">
  <div class="w-full max-w-6xl mx-auto px-4 py-6">
    {stats && (
      <div class="bg-gray-900 rounded-lg p-4 mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div>
          <div class="text-gray-400 text-xs mb-1">24H P&L</div>
          <div class={`text-lg font-bold ${stats.dailyPL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
            ${stats.dailyPL >= 0 ? '+' : ''}{stats.dailyPL.toFixed(2)}
            <span class="text-sm ml-1">
              ({stats.dailyPLPercent >= 0 ? '+' : ''}{stats.dailyPLPercent}%)
            </span>
          </div>
        </div>
        <div>
          <div class="text-gray-400 text-xs mb-1">Portfolio Value</div>
          <div class="text-lg font-bold text-white">${stats.totalValue.toFixed(2)}</div>
        </div>
        {stats.topGainer && (
          <div>
            <div class="text-gray-400 text-xs mb-1">Top Gainer</div>
            <div class="text-lg font-bold text-green-400">
              {stats.topGainer.symbol}
              <span class="text-sm"> +{stats.topGainer.plPercent}%</span>
            </div>
          </div>
        )}
        {stats.topLoser && (
          <div>
            <div class="text-gray-400 text-xs mb-1">Top Loser</div>
            <div class="text-lg font-bold text-red-400">
              {stats.topLoser.symbol}
              <span class="text-sm"> {stats.topLoser.plPercent}%</span>
            </div>
          </div>
        )}
      </div>
    )}

    <div>
      <h2 class="text-white text-2xl font-bold mb-4">Observations</h2>
      <div class="space-y-4">
        {blogPosts?.map(post => (
          <a href={`/news/${post.slug}`} class="block bg-gray-900 rounded-lg p-4 hover:bg-gray-800 transition-colors">
            <h3 class="text-white text-lg font-bold mb-2">{post.title}</h3>
            <p class="text-gray-400 text-sm mb-2">{post.slug}</p>
            <div class="text-gray-500 text-xs">
              {new Date(post.published_at).toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
              })}
            </div>
          </a>
        ))}
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-white text-2xl font-bold mb-4">Fake News, but It Could Be Worse.</h2>

      {/* Collapsible groups by source */}
      <div class="space-y-4">
        {sortedSources.map((source, i) => (
          <details class="group bg-gray-900 rounded-lg border border-gray-800">
            <summary class="cursor-pointer list-none px-4 py-3 flex items-center justify-between">
              <span class="text-white text-lg font-semibold">
                {source}
                <span class="ml-2 text-gray-500 text-sm">({groups[source].length})</span>
              </span>
              {/* chevron */}
              <svg
                class="h-4 w-4 text-gray-400 transition-transform duration-200 group-open:rotate-180"
                viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"
              >
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.17l3.71-2.94a.75.75 0 11.92 1.18l-4.25 3.37a.75.75 0 01-.92 0L5.21 8.41a.75.75 0 01.02-1.2z" clip-rule="evenodd" />
              </svg>
            </summary>

            <div class="border-t border-gray-800 px-4 py-3 space-y-3">
              {groups[source].map((article) => (
                <a
                  href={article.url}
                  target="_blank"
                  rel="noopener"
                  class="block bg-black/40 rounded-md p-3 hover:bg-black/60 transition-colors"
                >
                  <h4 class="text-white text-sm font-semibold mb-1 leading-tight">
                    {article.title}
                  </h4>

                  <p class="text-gray-400 text-xs mb-2 line-clamp-2">
                    {article.description}
                  </p>

                  <div class="flex items-center justify-between text-gray-500 text-[11px] sm:text-xs">
                    <div class="flex items-center gap-3">
                      <span>{new Date(article.published_at).toLocaleString()}</span>
                      <span class="text-gray-600">•</span>
                      <span class="text-blue-400">{article.topic}</span>
                    </div>
                    <span class="text-orange-400 font-mono">
                      Score: {fmtScore(article.dystopia_score)}
                    </span>
                  </div>
                </a>
              ))}
            </div>
          </details>
        ))}
      </div>
    </div>
  </div>
</Layout>
